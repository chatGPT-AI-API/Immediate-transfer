<!DOCTYPE html>
<html>
<head>
    <title>扫码支付</title>
    <style>
        .qr-container { text-align: center; padding: 20px; }
        .qr-code { margin: 20px auto; }
        .payment-info { margin: 10px 0; }
    </style>
</head>
<body>
    <div class="qr-container">
        <h2>扫码支付</h2>
        <div class="payment-info">
            <p>订单号: <span id="order-id">{{ order_id }}</span></p>
            <p>支付金额: <span id="amount">{{ amount }}</span> 元</p>
        </div>
        <div class="qr-code">
            <img id="qr-image" src="{{ qr_code }}" alt="支付二维码">
        </div>
        <p>请使用微信/支付宝扫描上方二维码完成支付</p>
    </div>
    
    <script>
        const orderId = document.getElementById('order-id').textContent;
        const amount = document.getElementById('amount').textContent;
        let checkInterval;

        function checkPaymentStatus() {
            fetch('/api/check_order_status?order_id=' + orderId)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'paid') {
                        // 支付成功
                        clearInterval(checkInterval); // 停止定时器
                        // alert('支付成功！'); // 可以选择移除或修改此提示
                        window.location.href = `/payment_callback?order_id=${orderId}&amount=${amount}&status=success`;
                    } else {
                        // 支付未完成，继续检查或处理其他状态
                        console.log('支付状态:', data.status);
                    }
                })
                .catch(error => {
                    console.error('检查支付状态时发生错误:', error);
                    // 错误处理，例如停止检查或给出提示
                    // clearInterval(checkInterval); // 发生错误时是否停止，取决于需求
                });
        }

        // 每5秒检查一次支付状态
        checkInterval = setInterval(checkPaymentStatus, 5000);

        // 可选：添加一个最大检查次数或总检查时间的限制，避免无限检查
        // let maxChecks = 60; // 例如，最多检查60次 (总计5分钟)
        // let checksDone = 0;
        // checkInterval = setInterval(() => {
        //     checksDone++;
        //     if (checksDone > maxChecks) {
        //         clearInterval(checkInterval);
        //         console.log('达到最大检查次数，停止检查。');
        //         // 可以选择提示用户或引导他们到其他页面
        //     } else {
        //         checkPaymentStatus();
        //     }
        // }, 5000);

    </script>
</body>
</html>